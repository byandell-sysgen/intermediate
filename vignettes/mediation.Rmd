---
title: "Mediaton Details"
author: "Brian S. Yandell"
date: "4/25/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Mediation examines the change in likelihood ratio, LR, (or LOD in genetic studies) for the relationship of a target and a driver by adjusting one at a time for a set of mediators. [For now, we ignore covariates and kinship.]

The idea is to compare the strength of evidence for effect of the driver ($D$) on the target ($T$) with or without a mediator ($M$). That is, how do the models $D\rightarrow T$ and $D \rightarrow M \rightarrow T$ compare? This is often done for a set of mediators ($M_1, M_2, ...$), looking for the strongest mediation, or drop in LOD attributable to the mediator.

### Causal models

A key reference for our work is: 
Li Y1, Tesson BM, Churchill GA, Jansen RC (2010) 
Critical reasoning on causal inference in genome-wide linkage and association studies.
_Trends Genet 26_: 493-498.
[doi:10.1016/j.tig.2010.09.002](http://dx.doi.org/10.1016/j.tig.2010.09.002).
This article has 10 models with driver $Q=D$, mediator $T1=M$ and target $T2=T$). There are three additional models (green) that imply additional interaction terms to modulate the causal relationship of $T$ with $M$.

![Li et al. (2010)](../inst/doc/nihms-249591-f0001.jpg)

The key models are in blue, corresponding to situations where the driver is known already to affect both the target and mediator, either directly or indirectly. To be exact, it is important to consider the joint distribution of $T$ and $M$ given $D$.
Write $f()$ as the likelihood (or density) for a given model. Thus $f(T\vert D)$ is the likelihood for the target given the driver, and $f(T)$ is the unconditional likelihood for the target. The four models can be written as

model | relationship | likelihood
----------- | ------------------- | -----------
causal | $D \rightarrow M \rightarrow T$ | $f(M\vert D)f(T\vert M)$
reactive | $D \rightarrow T \rightarrow M$ | $f(M\vert T)f(T\vert D)$
independent | $M \leftarrow D \rightarrow T$ | $f(M\vert D)f(T\vert D)$
correlated | $D \rightarrow (M,T)$ | $f(M,T\vert D) = f(M\vert D)f(T\vert M,D) = f(M\vert T,D)f(T\vert D)$

The last model (undecided or correlated) has driver affecting both mediator and target, with the latter two correlated with each other. There are multiple indistinguishable models that fall into this latter context. This is detailed in the following paper:
Chaibub Neto E, Broman AT, Keller MP, Attie AD, Zhang B, Zhu J, Yandell BS (2013)
Modeling causality for pairs of phenotypes in system genetics.
_Genetics 193_: 1003-1013.
[doi:10.1534/genetics.112.147124](http://dx.doi.org/10.1534/genetics.112.147124).

The above models are assessed relative to the joint likelihood without a driver, $f(M,T) = f(M\vert T)f(T) = f(M)f(T\vert M)$, through a likelihood ratio (or LOD for genetic models). For instance, for the causal model, the likelihood ratio is

$$\ell (\text{causal}) = \log\left({f(M\vert D)f(T\vert M) \over f(M,T)}\right) = \log(f(M\vert D)) - \log(f(M)).$$

In a similar fashion, the reactive LR is
$\ell (\text{reactive}) = \log(f(T\vert D)) - \log(f(T))$,
and the independent LR is

$$\ell (\text{independent}) = \log(f(M\vert D)) + \log(f(T\vert D)) - \log(f(M,T)).$$

Note that when comparing two models, the joint likelihood $f(M,T)$ cancels out.
Comparing these four models involves fitting five models:
$f(T\vert D)$,
$f(M\vert D)$,
$f(T\vert M)$,
$f(M\vert T)$,
and either $f(T\vert M,D)$ or $f(M\vert T,D)$.

## Mediation scans and likelihood ratios

Mediation scans focus on comparing models for the target with and without adjusting for a mediator. That is, we compare the LR $f(T\vert D)/f(T)$ with the LR $f(T\vert M,D)/f(T\vert M)$. Under the causal model, the latter LR is 1, since $f(T\vert M,D) = f(T\vert M)$. If the mediator has no effect on the target, then the latter LR is equal to the former. Thus, as the argument goes, a plot of 

$$\ell(\text{mediation}) = \log\left({f(T\vert D) \over f(T)}\right) - \log\left({f(T\vert M,D) \over f(T\vert M)}\right)$$

across multiple mediators $M$ should be near zero except at causal mediators, where it will approach $\log(f(T\vert D)/f(T))$. That is, for the causal model, $f(T\vert M,D)=f(T\vert M)$ and

$$\ell(\text{mediation}\vert\text{causal}) = \log\left({f(T\vert D) \over f(T)}\right)\,.$$

However, this difference will be negative if the reactive model is correct. For reactive mediators, $f(M\vert T,D) = f(M\vert T)$ and

$${f(T\vert M,D)\over f(T\vert M)} = {f(T\vert D)\over f(T)}{f(M\vert T,D)\over f(M\vert T)}{f(M\vert D)\over f(M)} = {f(T\vert D)\over f(T)}{f(M\vert D)\over f(M)}$$
and hence

$$\ell(\text{mediation}\vert \text{reactive}) = - \log\left({f(M\vert D) \over f(M)}\right)\,,$$

which is the opposite of the log LR for mediator given driver. Since we only consider mediators with significant effects, or large LR, this will be negative.

If target and mediator are independent given driver, a similar argument results in

$$\ell(\text{mediation}\vert \text{independent}) = - \log\left({f(T\vert M) \over f(T)}\right)\,,$$

which could be either positive or negative. If target and mediator are unconditionally independent, then $f(T\vert M) = f(T)$ and this will be zero. No simplification results for the correlated case, and the mediation could be positive or negative.

## Causal models with two drivers

Multi-parent populations developed over multiple generations leads to the opportunity for fine mapping, taking advantage of multiple alleles and short linkange disequilibrium. In this setting, one driver may not be enough to distinguish causal model for two correlated traits. Further, than can be other causal settings where there are potentially separate drivers for target and mediator, leading to the need for somewhat more complicated causal models. Consider the following which allows for drivers $C$ and $D$ for mediator $M$ and target $T$, respectively. The naive approach is to just allow for both in expanded relationships:

model | relationship | likelihood
----------- | ------------------- | -----------
causal | $C \rightarrow M \rightarrow T \leftarrow D$ | $f(M\vert C)f(T\vert M,D)$
reactive | $D \rightarrow T \rightarrow M \leftarrow C$ | $f(M\vert T,C)f(T\vert D)$
independent | $M \leftarrow C \leftrightarrow D \rightarrow T$ | $f(M\vert C)f(T\vert D)$
correlated | $(C,D) \rightarrow (M,T)$ | $f(M,T\vert C,D)$

However, we have to be very careful. The above makes sense if $C$ and $D$ are uncorrelated (unlinked in genetics). If they are totally correlated, then the above is incorrect and the problem reduces to the one-driver situation. In general, they will be partially correlated, and we will need to consider $C^*$ and $D^*$ for the causal and reactive models, which are constructed by adjusting one driver by the other. The following works whether drivers $C$ and $D$ are uncorrelated, totally correlated, or partially correlated.

model | relationship | likelihood
----------- | ------------------- | -----------
causal | $C \rightarrow M \rightarrow T \leftarrow D$ | $f(M\vert C)f(T\vert M,D^*)$
reactive | $D \rightarrow T \rightarrow M \leftarrow C$ | $f(M\vert T,C^*)f(T\vert D)$
independent | $M \leftarrow C \leftrightarrow D \rightarrow T$ | $f(M\vert C)f(T\vert D)$
correlated | $(C,D) \rightarrow (M,T)$ | $f(M,T\vert C,D) = f(M\vert C)f(T\vert M,D) = f(M\vert T,C)f(T\vert D)$

Comparing these four models involves fitting six models:
$f(T\vert D)$,
$f(M\vert C)$,
$f(T\vert M,D^*)$,
$f(M\vert T,C^*)$,
and either $f(T\vert M,D)$
or
$f(M\vert T,C)$.
Note that if $C$ and $D$ are uncorrelated, then $D^*$ and $C^*$ are null and the models look similar to those with one driver, except for the affinity of $D$ to $T$ and $C$ to $M$.

## Causal model selection tests

Causal model selection tests, presented in Chaibub Neto et al. (2013), compare the four models using intersection-unition tests. While we could proceed in terms of the five likelihoods as indicated above, it is equivalent for testing purposes to consider the following five likelihood ratios:

relationship | likelihood ratio
------------ | ----------------
1: $D\rightarrow T$ | $f(T\vert D)/f(T)$
2: $D\rightarrow M$ | $f(M\vert D)/f(M)$
3: $M\rightarrow T$ | $f(T\vert M)/f(T)$
4: $T\rightarrow M$ | $f(M\vert T)/f(M)$
5: $D\rightarrow T\leftarrow M$ | $f(T\vert M,D)/f(T\vert M)$

For the $k$th relationship comparing full versus reduced model, we compute LR$_k$ = $\ell_k = \log f(\text{full}_k) - \log f(\text{reduced}_k)$ = log likelihood ratio. Here we are comparing to $f(T)f(M)$, whereas earlier, we compared to $f(M,T)$, but that is a simple ratio that cancels out.

Similarlym df$_k$ = difference in degrees of freedom between full and reduced models, coef$_k$ = coefficient estimates under the full model, and indLR{_k} = vector of individual contributions to LR$_k$,

$$\text{indLR}_{ki} = \ell_{ki} = \log f(\text{full}_{ki}) - \log f(\text{reduced}_{ki})\,.$$

That is, $\text{LR}_k = \sum_i \text{indLR}_{ki}$, with the sum across all individuals. For instance, $f(\text{full}_{1i}) = f(T_i\vert D_i)$. The log likelihood ratios for the four models are constructed as:

model | relationship | likelihood | log likelihood ratio
----------- | ------------------- | ----------- | ---------------------
causal | $D \rightarrow M \rightarrow T$ | $f(M\vert D)f(T\vert M)$ | $\ell(\text{causal}) = \ell_2 + \ell_3$
reactive | $D \rightarrow T \rightarrow M$ | $f(M\vert T)f(T\vert D)$ | $\ell(\text{reactive}) = \ell_1 + \ell_4$
independent | $M \leftarrow D \rightarrow T$ | $f(M\vert D)f(T\vert D)$ | $\ell(\text{independent}) = \ell_1 + \ell_2$
correlated | $D \rightarrow (M,T)$ | $f(M,T\vert D) = f(M\vert D)f(T\vert M,D)$ | $\ell(\text{correlated}) = \ell_2 + \ell_5$

In a similar fashion, df, coef and indLR are combined.
Models are compared using an information criterion (BIC by default),
$IC_m = \ell_m + \text{df}_m * \log(n)$, with $m$ identifying the model. That provides a point estimate, but to get a p-value, we compare the vector of individual contributions to $IC$,

$$IC_{mi} = \ell_{mi} + \text{df}_{m} * \log(n) / n$$

Chaibub Neto et al. (2013) considered sign test, normal, and normal joint tests versions, building on the original idea of Vuong. Here we add the Wilcoxon signed rank test. That is, for two models compare the $IC_{mi}$ vectors by replacing these values by their ranks, and finding the difference of the sum of ranks between the two models. This has the advantage of being nonparametric and almost as powerful as the normal test.

The six possible pairs of the models are compared using the intersection-union approach, and the smallest p-value is reported, along with the model that best fit the data. This procedure has been shown to have good power for comparison of multiple entries; therefore we do not propose any adjustment.

When there are two drivers, some adjustment needs to be made. The five relationships are:

relationship | likelihood ratio
------------ | ----------------
$1^*$: $D\rightarrow T$ | $f(T\vert D)/f(T)$
$2^*$: $C\rightarrow M$ | $f(M\vert C)/f(M)$
$3^*$: $M\rightarrow T \leftarrow D^*$ | $f(T\vert M,D^*)/f(T)$
$4^*$: $T\rightarrow M \leftarrow C^*$ | $f(M\vert T,C^*)/f(M)$
$5^*$: $D\rightarrow T\leftarrow M$ | $f(T\vert M,D)/f(T\vert M,D^*)$

and the four models with their likelihood ratios are:

model | relationship | likelihood | log likelihood ratio
----------- | ------------------- | ----------- | ---------------------
causal | $C \rightarrow M \rightarrow T \leftarrow D$ | $f(M\vert C)f(T\vert M,D^*)$ | $\ell(\text{causal}) = \ell_{2^*} + \ell_{3^*}$
reactive | $D \rightarrow T \rightarrow M \leftarrow C$ | $f(M\vert T,C^*)f(T\vert D)$ | $\ell(\text{reactive}) = \ell_{1^*} + \ell_{4^*}$
independent | $M \leftarrow C \leftrightarrow D \rightarrow T$ | $f(M\vert C)f(T\vert D)$ | $\ell(\text{independent}) = \ell_{1^*} + \ell_{2^*}$
correlated | $(C,D) \rightarrow (M,T)$ | $f(M,T\vert C,D) = f(M\vert C)f(T\vert M,D)$ | $\ell(\text{correlated}) = \ell_{2^*} + \ell_{5^*}$

## Implementation

The causal model selection tests (CMST) are implemented in the [R/qtlhot](https://cran.r-project.org/web/packages/qtlhot) available on [CRAN](https://cran.r-project.org). They have been updated and extended in this [R/intermediate](https://github.com/byandell/intermediate).

Computation of the (CMST) is orchestrated by the [mediation_test](https://github.com/byandell/intermediate/blob/master/R/mediation_test.R) function, which can process one target and multiple mediators. It is assumed that the mediators have already been screened to have a significant relationship to the driver. After some preprocessing, for instance to remove data with missing values, `mediation_test` calls an internal function `cmst_default`, which uses a fit function to compute LR, df, coef and indLR for the five relationships. The default fit function, `fitDefault`, allows for covariates; another fit function, `fitQtl2`, is a wrapper for [qtl2::fit1](https://github.com/rqtl/qtl2/blob/master/R/fit1.R), which allows for correlation of individuals using a `kinship` matrix. These fits are combined to yield the four models, and then compared with a test function (`wilcIUCMST`, `binomIUCMST`, `normIUCMST`, or `normJointIUCMST`) to conduct the six tests.

The `fitDefault` uses the QR decomposition. Assume we have response `y` (say the target) and predictors `X` (say driver and mediator combined), the steps are:

```
n <- length(y)
qrX <- qr(cbind(X,1))
df <- qrX$rank
RSS <- sum(qr.resid(qrX, y) ^ 2)
LR <- -(n/2) * (log(RSS)))
indLR <- dnorm(y, qr.fitted(qrX, y), sqrt(RSS / n), log = TRUE)
coef <- qr.coef(qrX, y)
```

In the case of two drivers we need to calculate $f(T\vert M,D^*)$ and $f(M\vert T,C^*)$ for relationships 3 and 4.

We compute $D^*$ by taking a QR decomposition of $C$ and getting the residuals applied to each column of $D$

```
qrC <- qr(cbind(C,1))
Dstar <- D
for(i in seq_along(ncol(D))) Dstar[,i] <- qr.resid(qrC, D[,i])
```

Note that in the special case $C=D$, the residuals will be zero, and there will be no contribution, as desired. When $C\perp D$ (uncorrelated drivers), the residuals will be the original matrix $D$.

More machinery is needed to accommodate covariates and kinship.